<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8'>
<meta name="viewPort", content="width=device-width, initial-scale=1">
<title>Network of CDO</title>
<script src='http://d3js.org/d3.v3.min.js'></script>
<script src="js/vendor/jquery.js"></script>
<script src="http://d3js.org/topojson.v0.min.js"></script>
<script src="http://code.jquery.com/ui/1.9.2/jquery-ui.js"></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/foundation/6.2.3/foundation.js'></script>
<script src='https://cdnjs.cloudflare.com/ajax/libs/foundation/6.2.3/plugins/foundation.slider.js'></script>
<script type='text/javascript' src="http://labratrevenge.com/d3-tip/javascripts/d3.tip.v0.6.3.js"> </script>
<link rel="stylesheet" href="style.css">
<link href="https://fonts.googleapis.com/css?family=Bree+Serif" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Source+Serif+Pro" rel="stylesheet">
<link href="https://fonts.googleapis.com/css?family=Source+Code+Pro|Source+Serif+Pro" rel="stylesheet">
</head>

<body>
<div id="header">
<h2>
Interactive Network of Bank and CDO
</h2>
</div>

<div id="background">
    <p>In the attached visualization, I have mocked up some hypothetical relationships to banks and CDOs to explore the impact of failing CDPs on the finanical sector. The visualization has the following properties:</p>
        <li><span>Each bank is noted by a blue circle; each CDP is noted by a yellow circle.</span></li>
        <li><span>Banks can own a CDO or multiple CDOs. The ownership of a CDO by a bank is denoted by a gray link between the two circles or nodes.</span></li>
        <li><span>A given CDO can have multiple owners. That is, two banks can own a single CDO; 50% of a CDO is owned by each bank.</span></li>
    <p>We'll use the visualization to consider several different impacts of the housing crisis (and the failure of CDOs) on the banking sector. In this first section, you will be able to consider hwo the failure of a CDO may affect the solvency of a bank. A bank is solvent if it has enough assets. In this simplified model, suppose that the only assets of a bank are the CDOs that it owns.</p>

</div>

<div id="viz">
    <div id="container"></div>
    <input type="button" name="newgraph" value="CDOs are connected" id="redraw" onclick="addEdges();" />
    <input type="button" name="reset" value="Default" id="reset" onclick="reset();initalSet();" />
</div>

<div id="introduction">
    <div id="Part1">
    <h3><strong>Part 1</strong></h3>
    </div>

    <li id="question1"><span>For each bank in the model, identify how many CDO's it own.</span></li>
    <li id="question2"><span>For each CDO (i=1,...6), if it fails, what are the impacts on bank failure. Use <strong>"Threshold"</strong> slider bar to define the percentage of a bank's CDO fails.</span></li><br>
    If more thatn X percent of a bank's CDO fails, the bank will fail.</p>
         <p><strong>Threshold</strong></p>
         <input id="sliderbar" type="range" min="0" max="100" value="0" step="1" onChange="threshold(this.value);effectOfCdO();" />
         <span id="range">0 %</span><br>
        <label>Which CDO will fail: <br><br></label>
         <select id="cdo" name="CDO_name" onChange="effectOfCdO()">
            <option selected value=-1>Select a CDO</option>
            <option value=4>CDO1</option>
            <option value=5>CDO2</option>
            <option value=6>CDO3</option>
            <option value=7>CDO4</option>
            <option value=8>CDO5</option>
            <option value=9>CDO6</option>
         </select>
</div> 

<div id="options">
         <li id="question3"><span id="span1">Co-ownership of CDOs links together different banks that were previously unrelated. While co-ownership creats links between different banks, these links are sometimes more direct or sometimes more indirect. Consider the 'distance' between any two banks in the CDO visualization. You can choose the bank and then identify the number of entities in relationship to this bank with a given number of links.</span></li>
<!--          <dd>
             <ol id="orderlist">
                 <li id="question4a"><span>For each bank X, how many other banks is it related to (in sum)?</span></li>
                 <li id="question4b"><span>For each bank X, within 3 CDO links, how many other banks is it related to?</span></li>
                 <li id="question4c"><span>For each bank X, within 1 CDO link, how many other banks is it related to?</span></li>
             </ol>
         </dd> -->

         <!-- <p id="p1">Choose the bank you would like to explore and the number of CDO links</p> -->
         <div id="bank_cdo">
            <select id="bank" name="Bank_explore" onchange="crossOwnership();">
            <option selected value=-1>Select a Bank</option>
            <option value=0>Bank A</option>
            <option value=1>Bank B</option>
            <option value=2>Bank C</option> 
            <option value=3>Bank D</option>
         </select>
         <select id="cdoOwnership" name="CDO_Ownership" onchange="crossOwnership();">
             <option selected value=-1>Select The Number of CDO Links</option>
            <option value=1>1</option>
            <option value=2>2</option> 
            <option value=3>3</option>
         </select> 
         </div>
    <div id="shortestWay">
        <li><span>What is the shortest path between the selected banks?</span></li>
        <div style="display:inline-block; vertical-align:center;">The shortest path between </div>
        <select id="bankList1" onchange="deactiveOption();shortestPath();">
            <option selected value=-1> Select a Bank</option>
            <option value=0>Bank A</option>
            <option value=1>Bank B</option>
            <option value=2>Bank C</option> 
            <option value=3>Bank D</option>
        </select>
        <div style="display:inline-block; vertical-align:center;"> and</div>
        <select id="bankList2" onchange="deactiveOption();shortestPath();">
             <option selected value=-1>Select a Bank</option>
             <option value=0>Bank A</option>
             <option value=1>Bank B</option>
             <option value=2>Bank C</option> 
             <option value=3>Bank D</option>
             </select>
        <div style="display: inline-block; vertical-align: center;"> contains</div>
        <input type="text" name="shortestDistance" value=" " id="path" />
        <div style="display: inline-block; vertical-align: center;"> CDOs and banks</div>
        <p id="paragraph2">With increased financial securitization, CDOs started being broken up and owned by other financial intermediaries. Some of these financial intermediaries used these CDOs to make new CDOs. While the technical details get a bit complex here, what we saw is that CDOs were owned by both banks and CDOs. We want to explore in our visualization how this ownership pattern affected the financial market. To complete the work in this section, you need to click the blue button <strong>"CDOs are connected"</strong> in the top of visualization. </p>
    </div>      
</div>


<div id="distance">
    <div id="Part2">
    <h3><strong>Part 2</strong></h3>
    </div>
    <li id="question5"><span>Now, if CDO i fails, how many banks fails? Use <strong>"Threshold"</strong> slider to define the percentage of originating CDOs fails and the percentage of a bank's CDOs fails.</span></li>

</div>

<div id="tooltip"></div>

<script type="text/javascript">

var dataset={
     nodes:[
	    {
         name:"Bank A",
         size:3,
         group:1,
		 x:300,
		 y:260,
		 fixed:true
		 },
        {
         name:"Bank B",
         size:2,
         group:1,
		 x:650,
		 y:500,
		 fixed:true
		 },
        {
         name:"Bank C",
         size:2,
         group:1,
		 x:850,
		 y:305,
		 fixed:true
          },
        {
         name:"Bank D",
         size:1,
         group:1,
		 x:400,
		 y:90,
		 fixed:true
         },
        {
         name:"CDO 1",
         size: 1,
         group:2,
		 x:600,
		 y:260,
		 fixed:true
         },
        {
         name:"CDO 2",
         size:2,
         group:2,
		 x:500,
		 y:380,
		 fixed:true
         },
        {
         name:"CDO 3",
         size: 1,
         group:2,
		 x:250,
		 y:430,
		 fixed:true
         },
        {
         name:"CDO 4",
         size:2,
         group:2,
		 x:900,
		 y:430,
		 fixed:true
         },
        {
         name:"CDO 5",
         size:1,
         group:2,
		 x:200,
		 y:200,
		 fixed:true
         },
        {
         name:"CDO 6",
         size:1,
         group:2,
		 x:800,
		 y:130,
		 fixed:true
         }
    ],
     link:[
	 {
         source: 0, 
         target: 4,
         },
        {
         source:0,
         target:5
         },
        {
         source: 0, 
         target: 6
         },
        {
         source: 1, 
         target: 5
         },
         {
         source: 1, 
         target: 7
         },
        {
         source: 2, 
         target: 7
		 },
        {
         source: 2, 
         target: 9
         },
        {
         source: 3, 
         target: 8
         }
		 ]
}

var width=window.innerWidth,
    height=window.innerHeight;
var toggle=0; // store whether the highlighting is on

//var color=d3.scale.category20();
var force=d3.layout.force()
            .nodes(dataset.nodes)
            .links(dataset.link)
            .size([width,height])
            .start();


var svg=d3.select("div#container")
          .append("svg")
          .attr("width",width)
          .attr("height",height)
          .attr('viewBox','0 0 '+width*1.2+' '+height*1.2)
          .attr('perserveAspectRatio','xMidYMid meet')
          .append("g");
		  
var link=svg.selectAll(".link")
            .data(dataset.link)
            .enter()
            .append("line")
            .attr("class","link");

var node=svg.selectAll(".node")
             .data(dataset.nodes)
			 .enter()
			 .append("g")
			 .attr("class","node")
			 .call(force.drag);
			 
	node .append("circle")
	     .attr("r", function(d){
	                 return d.size*13;
	                 })
         .style("fill", function (d) {
	           return d.group==1?"rgba(63, 127, 191, 0.9)":"rgba(255, 229, 0, 0.9)";
            });
	node.append("text")
	    .attr("dx",-15)
		.text(function(d){
		     return d.name;
			 });
	node.on('click',neighboringNodes);
	
var tip=d3.select("text")
          .append("div")
          .attr("class","tooltip");
		   
// Add a legend
var colordata=[{value:1,name:"Bank"},{value:2,name:"CDO"}];

var legend = svg.selectAll('.legend')
                .data(colordata)
                .enter().append('g')
                .attr('class', 'legend')
                .attr('ID', function(d) { return d.name })
                .attr("transform", function(d,i) {
                        return "translate(" + 60 + "," + (i+3)*30 + ")";
                });

	legend.append("rect")
      	.attr('width', 25).attr('height', 20)
	  	.attr('x', 30).attr('y', 5)
      	.style('fill', function(d) {
        	if (d.value==1){
			return "rgba(63, 127, 191, 0.9)";
			}
			if (d.value==2){
			return "rgba(255, 229, 0, 0.9)";
			}
      	});

	legend.append("text")
      	.attr('x', 70).attr('y', 19)
      	.text(function(d) { return d.name; })
      	.attr("stroke","black");

	force.on("tick",function(){
	link.attr("x1",function(d){
          return d.source.x;
        })
    	.attr("y1",function(d){
          return d.source.y;
        })
        .attr("x2",function (d){
          return d.target.x;
        })
        .attr("y2",function(d){
          return d.target.y;
        });
	node.attr("transform",function(d){
     	return "translate("+d.x+","+d.y+")";});
		});

		
var linkedByIndex={}; // this is an array to store nodes and its directly connected neighbors
for (i=0;i<dataset.nodes.length;i++){
        linkedByIndex[i+","+i]=1;
};


dataset.link.forEach(function (d) {
    linkedByIndex[d.source.index + "," + d.target.index] = 1;
});

var cdo=document.getElementById('cdo');

var cdoLink=document.getElementById("cdoOwnership");
var bank=document.getElementById("bank");

var bank1=document.getElementById("bankList1");
var bank2=document.getElementById("bankList2");
var redraw=document.getElementById("redraw");
var original=document.getElementById("question2").innerHTML;

var adding=0;
function addEdges(){
    if (adding==0){
        dataset.link.push(
         {
         source: 5, 
         target: 6
         },
         {
         source: 4, 
         target: 7
         });
        dataset.nodes[4].size=2;
        dataset.nodes[6].size=2;
        dataset.nodes[7].size=3;
        dataset.nodes[5].size=3;
        reset();
        adding=1;
        document.getElementById("redraw").value="CDOs are NOT connected";
        document.getElementById("Part1").innerHTML="Part 2";
        document.getElementById("question1").style.display="none";
        document.getElementById("question2").innerHTML=document.getElementById("question5").innerHTML;
        document.getElementById("question3").style.display="none";
        document.getElementById("bank_cdo").style.display="none";
        document.getElementById("paragraph2").style.display="none";
    }else{
        dataset.link.splice(dataset.link.length-2,2);
        adding=0;
        document.getElementById("redraw").value="CDOs are connected";
        document.getElementById("Part1").innerHTML="Part 1";
        document.getElementById("question1").style.display="block";
        document.getElementById("question2").innerHTML=original;
        document.getElementById("question3").style.display="block";
        document.getElementById("bank_cdo").style.display="block";
        document.getElementById("paragraph2").style.display="block";
        dataset.nodes[4].size=1;
        dataset.nodes[6].size=1;
        dataset.nodes[7].size=2;
        dataset.nodes[5].size=2;
        reset();
    }
}

var initSet=0;
function initalSet(){
    if (adding==1){
        dataset.link.splice(dataset.link.length-2,2);
        adding=0;
        document.getElementById("redraw").value="CDOs are connected";
        document.getElementById("Part1").innerHTML="Part 1";
        document.getElementById("question1").style.display="block";
        document.getElementById("question2").innerHTML=original;
        document.getElementById("question3").style.display="block";
        document.getElementById("bank_cdo").style.display="block";
        document.getElementById("paragraph2").style.display="block";
        dataset.nodes[4].size=1;
        dataset.nodes[6].size=1;
        dataset.nodes[7].size=2;
        dataset.nodes[5].size=2;
        reset();
    }
}

function deactiveOption(){

	var d=bank1.value;
	var dd=bank2.value;
	if (d!=-1){
		for (var i=0;i<bank2.length;i++){
			bank2.options[i].disabled=false;
			if (bank2.options[i].value==d){
				bank2.options[i].disabled=true;
			}
		}
	}
	if (dd!=-1){
		for (var i=0;i<bank1.length;i++){
			bank1.options[i].disabled=false;
			if (bank1.options[i].value==dd){
				bank1.options[i].disabled=true;
			}
		}
	}
}

// Find the shortest path

function shortestPath(){
    var starting=dataset.nodes[parseInt(bank1.value,10)];
    var ending=dataset.nodes[parseInt(bank2.value,10)];

    if (bank1.value!=-1 && bank2.value!=-1){
        if ((starting.name=="Bank A" && ending.name=="Bank B")|(starting.name=="Bank B" && ending.name=="Bank A")){
          
          var highlightedPath=new Array();
          if (adding==1){
            highlightedPath=["Bank A","CDO 2","Bank B"]; 
          }else{
            highlightedPath=["Bank A","CDO 2","Bank B"];
          }
            node.transition()
                .style("opacity",function(o){
                    return highlightedPath.includes(o.name)? 0.9:0.1;
                    });
            link.transition()
                .style("stroke",function(o){
                        return highlightedPath.includes(o.source.name) && highlightedPath.includes(o.target.name)? "#F50F0F":"#999999";
                     })
                .style("opacity", function(o){
                    return highlightedPath.includes(o.source.name) && highlightedPath.includes(o.target.name)? 1:0.1;
                    });
            document.getElementById('path').value=(highlightedPath.length-2);
        }

        if ((starting.name=="Bank A" && ending.name=="Bank C")|(starting.name=="Bank C" && ending.name=="Bank A")){
          var highlightedPath=new Array();
            if (adding==1){
                highlightedPath=["Bank A","CDO 1","CDO 4","Bank C"]; 
            }else{
                highlightedPath=["Bank A","CDO 2","CDO 4","Bank C","Bank B"];
            }
            node.transition()
                .style("opacity",function(o){
                    return highlightedPath.includes(o.name)? 0.9:0.1;
                    });
            link.transition()
                .style("stroke",function(o){
                        return highlightedPath.includes(o.source.name) && highlightedPath.includes(o.target.name)? "#F50F0F":"#999999";
                     })
                .style("opacity", function(o){
                    return highlightedPath.includes(o.source.name) && highlightedPath.includes(o.target.name)? 1:0.1;
                    });
            document.getElementById('path').value=(highlightedPath.length-2);
        }

        if ((starting.name=="Bank B" && ending.name=="Bank C")|(starting.name=="Bank C" && ending.name=="Bank B")){

          var highlightedPath=new Array();
            if (adding==1){
                highlightedPath=["Bank B","CDO 4","Bank C"]; 
            }else{
                highlightedPath=["Bank B","CDO 4","Bank C"];
            }
            node.transition()
                .style("opacity",function(o){
                    return highlightedPath.includes(o.name)? 0.9:0.1;
                    });
            link.transition()
                .style("stroke",function(o){
                        return highlightedPath.includes(o.source.name) && highlightedPath.includes(o.target.name)? "#F50F0F":"#999999";
                     })
                .style("opacity", function(o){
                    return highlightedPath.includes(o.source.name) && highlightedPath.includes(o.target.name)? 1:0.1;
                    });
            document.getElementById('path').value=(highlightedPath.length-2);
        }

        if (starting.name=="Bank D"|ending.name=="Bank D"){
            node.transition()
                .style("opacity",0.9);
            link.transition()
                .style("stroke","#999999")
                .style("opacity", 1);
            document.getElementById('path').value=0;
        }
    }
}

function neighboringNodes(d){
     if (toggle==0){
			     var neighborNames=[];
				 node.each(function(o){
				     if (isConnected(d,o)){
					     if (d.name!=o.name){
					         neighborNames.push(o.name);
					         }
						 }
					});
				 var neighborNamesList=neighborNames.join("<br />");
				 var tooltipDiv = document.getElementById('tooltip');
				     tooltipDiv.innerHTML = "<strong>"+d.name+"</strong>"+ "<br />" + 
					 "Size: "+ d.size + "<br />"+"<strong>"+"Direct Connections: "+"</strong>"+"<br />"+neighborNamesList;
				     tooltipDiv.style.display = "block";
				     d=d3.select(this).node().__data__;
                     node.transition()
					     .style("opacity",function(o){
                             return neighboring(d,o)|neighboring(o,d)? 0.9:0.1;
                            });
                     link.transition()
						 .style("stroke",function(o){
						         return d.index==o.source.index | d.index==o.target.index? "#F50F0F":"#999999";
								 })
					     .style("opacity", function(o){
                             return d.index==o.source.index | d.index==o.target.index? 1:0.1;
                             });
					toggle=1;
		}else{
		     var tooltipDiv=document.getElementById('tooltip');
			      tooltipDiv.style.display="none";
			node.style("opacity",0.9)
				.attr("r",function(d){
						 return d.size*13;
					});
            link.style("opacity",1)
                .style("stroke","#999999")
                .style("stroke-width","2px");
             toggle=0;
		}
	}
		
 // There should be a way to optimize function crossOwnership. 
function crossOwnership(){
     var cdoID=parseInt(cdoLink.value,10);
	 var d=dataset.nodes[parseInt(bank.value,10)];
			if (d!="undefined"){
				if (cdoID==1){
					var connected=[];
						node.each(function(o){
							if (isConnected(d,o)&&o.group==2&&o!=d){
								connected.push(o);
							}
						} 
					);

					
                    var nodeHightlight=[];
					node.each(function(o){
						for (var i=0; i<connected.length; i++){
							if (o.group==1&&isConnected(o,connected[i])&&o!=d){
								nodeHightlight.push(o);
								nodeHightlight.push(connected[i]);
							}
						}
					});
                    
                    if (nodeHightlight.length!=0&&!nodeHightlight.includes(d)){
                    	nodeHightlight.push(d)
                    }

					node.transition()
						.delay(100)
						.duration(1000)
						.style("opacity",function(o){
                             return nodeHightlight.includes(o)? 0.9:0.1;
                        });
					 
					link.style("opacity",function(o){
						return nodeHightlight.includes(o.source)&&nodeHightlight.includes(o.target)? 0.9:0.1;
                      })
						.style("stroke",function(o){
							return nodeHightlight.includes(o.source)&&nodeHightlight.includes(o.target)? "red":"#999999";
						});
	    }
		if (cdoID==2){
                var connected=[];
                node.each(function(o){
                     if (isConnected(d,o)&&o.group==2){
                          connected.push(o);
                         }
                     } 
                 );

                
				 var connected1=[];
			     node.each(function(o){
			     	connected.forEach(function(e){
			         	if (isConnected(e,o)&&o.group==1&&o!=d){
				         connected1.push(o);
				         connected1.push(e);
					     }
				       }
					 )
				    }
			     );
				 
			

				 var connected2=[];
			     node.each(function(o){
			     	connected1.forEach(function(e){
			         	if (isConnected(e,o)&&o.group==2&&e.group==1&&(!connected2.includes(o))){
				         	connected2.push(o);
				         	connected2.push(e);
					     }
				       }
					 )
				    }
			     );
                 
        
			     var connected3=[];
			     node.each(function(o){
			     	connected2.forEach(function(e){
			     		if(isConnected(o,e)&&e.group==2&&o.group==1&&(!connected2.includes(o))){
			     			connected3.push(o);
			     			connected3.push(e);
			     		}
			     		if (e.group==1&&(!connected3.includes(e))){
			     			connected3.push(e);
			     		}
			     	})
			     });

			     if (connected3.length!=0&&!connected3.includes(d)){
			     	connected3.push(d);
			     }


                 node.transition()
				     .delay(100)
					 .duration(1000)
				     .style("opacity",function(o){
                             return connected3.includes(o)? 0.9:0.1;
                             });
					 
	             link.style("opacity",function(o){
                      return connected3.includes(o.source)&&connected3.includes(o.target)? 0.9:0.1;
                      })
                     .style("stroke",function(o){
                         return connected3.includes(o.source)&&connected3.includes(o.target)? "red":"#999999";
                     })
                     .style("stroke-width","2px");
		}
		if (cdoID==3){
	         // direct neighbors
	        var connected=[];
                node.each(function(o){
                     if (isConnected(d,o)&&o.group==2&&o.size>1){
                          connected.push(o);
                         }
                     });

			// 2nd order neighbors and 1 CDO links
			var connected1=[];
			     node.each(function(o){
			     	connected.forEach(function(e){
			         	if (isConnected(e,o)&&o.group==1&&o!=d){
				         connected1.push(o);
				         connected1.push(e);
					     }
				       })
				    });

			 // 3rd order neighbors
			var connected2=[];
			     node.each(function(o){
			     	connected1.forEach(function(e){
			         	if (isConnected(e,o)&&o.group==2&&e.group==1&&(!connected1.includes(o))&&o.size>1){
				         	connected2.push(o);
				         	connected2.push(e);
					     }
				       })
				    });
		
			// 4th order neighbors and 2 CDO links
			 var connected3=[];
			     node.each(function(o){
			     	connected2.forEach(function(e){
			     		if(isConnected(o,e)&&e.group==2&&o.group==1&&(!connected2.includes(o))&&o.size>1){
			     			connected3.push(o);
			     			connected3.push(e);
			     		}
			     	})
			     });
	
			// 5th order neighbors
		     var connected4=[];
			 node.each(function(o){
			     connected3.forEach(function(e){
			         if (isConnected(e,o)&&e.group==1&&o.group==2&&(!connected3.includes(o))){
				         connected4.push(o);
				         connected4.push(e);
					     }
				    })
				});

             var connected5=[];
             node.each(function(o){
             	connected4.forEach(function(e){
             		if (isConnected(e,o)&&e.group==2&&o.group==1&&(!connected4.includes(o))){
             			connected5.push(o);
             			connected5.push(e);
             		}
             	})
             });

			 if(connected5.length!=0&&(!connected5.includes(d))){
			 	connected5.push(d);
			 }

			// 6th order neighbors and 3 CDO links
                if (connected5.length!=0){
                     node.transition()
                         .delay(100)
                         .duration(1000)
                         .style("opacity",function(o){
                                 return connected5.includes(o)? 0.9:0.1;
                                 });
                         
                     link.style("opacity",function(o){
                          return connected5.includes(o.source)&&connected5.includes(o.target)? 0.9:0.1;
                          })
                         .style("stroke",function(o){
                             return connected5.includes(o.source)&&connected5.includes(o.target)? "red":"#999999";
                         })
                         .style("stroke-width","2px");
                }else{
                    var combined=connected1.concat(connected2,connected3,d);

                    node.transition()
                         .delay(100)
                         .duration(1000)
                         .style("opacity",function(o){
                                 return combined.includes(o)? 0.9:0.1;
                                 });
                         
                     link.style("opacity",function(o){
                          return combined.includes(o.source)&&combined.includes(o.target)? 0.9:0.1;
                          })
                         .style("stroke",function(o){
                             return combined.includes(o.source)&&combined.includes(o.target)? "red":"#999999";
                         })
                         .style("stroke-width","2px");
                }
            }
		}
}

// Show the effect of CDO when the CDO fails
// Note: this function needs to be optimized.
function effectOfCdO(){
         var  d=dataset.nodes[parseInt(cdo.value,10)];
		 var  thresh=parseInt(document.getElementById("range").innerHTML,10);
	     var  cuttingNumber=threshold(thresh);
		 var  cdoNeighborIndex=[];
		 var  cdoNeighborPartial=[];
         var  cdoNeighborPartial1=[];
         var  directNodes2=[]; // this array will store all the direct nodes which fails in the second wave
		 var  waveContinueing=1;
		 var  secondWave=1;
		 var  checking=1;
		 var  nodeLeft=[];
	 
	 // all the neighbors of node d
    if (d!=undefined){
        node.each(function(o){
        	if (isConnected(d,o)){
        		cdoNeighborIndex.push(o);
        	}
        });
        
       // the neighbors which fail directly after d fails
    if (adding==0){

        // Part 1: CDOs are not connected.

        cdoNeighborIndex.forEach(function(o){
            if (isConnected(d,o) && ((100/o.size)>cuttingNumber)){
                cdoNeighborPartial.push(o);
            }
        });

        if (!cdoNeighborPartial.includes(d)){
            cdoNeighborPartial.push(d);
        }

        node.transition()
            .delay(100)
            .duration(3000)
            .style('opacity',function(o){
                return cdoNeighborPartial.includes(o)? 0.1:0.9;
            });
        link.transition()
            .delay(100)
            .duration(3000)
            .style('opacity', function(o){
                return cdoNeighborPartial.includes(dataset.nodes[o.source.index])|cdoNeighborPartial.includes(dataset.nodes[o.target.index])? 0.1:1;
            })
    }else{
        // Part 2: CDOs are connected.

		cdoNeighborIndex.forEach(function(o){
			if (isConnected(d,o) && ((100/o.size)>cuttingNumber)){
				cdoNeighborPartial.push(o);
                cdoNeighborPartial1.push(o);
			}
		});
         
        if (!cdoNeighborPartial.includes(d)){
            cdoNeighborPartial.push(d);
        }
        if (!cdoNeighborPartial1.includes(d)){
            cdoNeighborPartial1.push(d);
        }
		// Check if other direct neighbors will fail

        if (d.size==1&&cdoNeighborIndex.splice(d,1).every(elem => elem.size>100/cuttingNumber)){
        	nodeLeft.push(d);
        }else{
         	if (cdoNeighborIndex.length!=cdoNeighborPartial.length&&cdoNeighborPartial.length!=0){
         		
            	while(checking==1){
            		
            		for (i=0; i<cdoNeighborIndex.length; i++){
            			var counting=0;
            			for (j=0 ; j<cdoNeighborPartial.length; j++){
            				if (isConnected(cdoNeighborIndex[i],cdoNeighborPartial[j])&&(!cdoNeighborPartial.includes(cdoNeighborIndex[i]))){
            					counting++;
            				}
            			}
            			if (((100/cdoNeighborIndex[i].size)*counting)>cuttingNumber){
            				cdoNeighborPartial.push(cdoNeighborIndex[i]);
                            directNodes2.push(cdoNeighborIndex[i]);
            			}
            		}

            		var nodeChecking=[];
            		for (i=0; i<cdoNeighborIndex.length; i++){
            			for (j=0 ; j<cdoNeighborPartial.length; j++){
            				if (isConnected(cdoNeighborIndex[i],cdoNeighborPartial[j])&&(!cdoNeighborPartial.includes(cdoNeighborIndex[i]))&&(cdoNeighborIndex[i].size)<(100/cuttingNumber)){

            					nodeChecking.push(cdoNeighborIndex[i]);
            					}

            				}
            			}

            			if (nodeChecking.length==0){
            				checking=0;
            			}
            		}
            	}
 
         var undirectNodes1=[]; // undirectNodes which will fail

        // Find undirect neighbors which will fail
		for (var i=0;i<cdoNeighborPartial.length;i++){
			         nodeLeft.push(cdoNeighborPartial[i]);
		}
    	

    	var cc=0;

		while (waveContinueing==1){
			var newNode=[];
			node.each(function(o){
				nodeLeft.forEach(function(e){
					if (isConnected(o,e)&&(!nodeLeft.includes(o))&&(100/o.size)>cuttingNumber){
							newNode.push(o);
					}
				})
			});
 

			if (newNode.length>0){
			    for (i=0;i<newNode.length;i++){
			    	nodeLeft.push(newNode[i]);
			    	}
                undirectNodes1.push(newNode);
			    }
         
           	if ((newNode.every(elem => elem.size <= 1))){
            		waveContinueing=0;
            	}else{
            		cc++;
            	}
			}


       // Find the nodes which fail because its neighbors fail.   
       var undirectNodes2=[]; 
       var undirectNodes3=[];
          while(secondWave==1){
          	for (var i=0; i<dataset.nodes.length; i++){
        			var count=0;
        			for (var j=0; j<nodeLeft.length; j++){

        				if (isConnected(dataset.nodes[i],nodeLeft[j])&&dataset.nodes[i]!=nodeLeft[j]){
        					count++;
        				}
        			}

        			if ((((100/dataset.nodes[i].size)*count)>cuttingNumber)&&(!nodeLeft.includes(dataset.nodes[i]))){
        				nodeLeft.push(dataset.nodes[i]);
                        undirectNodes2.push(dataset.nodes[i]);
        			}
        		}
                    
                    var nodeElse=[];
        			for (var i=0; i<dataset.nodes.length; i++){
        				for (var j=0; j<nodeLeft.length; j++){
        					if (isConnected(dataset.nodes[i],nodeLeft[j])&&(!nodeLeft.includes(dataset.nodes[i]))&&dataset.nodes[i].size<(100/cuttingNumber)){
        						nodeElse.push(dataset.nodes[i]);
                                undirectNodes3.push(dataset.nodes[i]);
        					}
        				}
        			}
                    
        			if (nodeElse.length==0){
        				secondWave=0;
        			}	

                }
    }
        
        nodeLeft.push(d);
        //cdoNeighborPartial1.push(d);

        // Fade out the failing nodes and its edges.
			      	node.transition()
				         .delay(100)
				         .duration(3000)
						 .style("opacity",function(o){
						      return cdoNeighborPartial1.includes(o)? 0.1:0.9;
							});	
                     node.transition()
                        .delay(100)
                        .duration(3000)
                        .style("opacity",function(o){
                            return directNodes2.includes(o)|cdoNeighborPartial1.includes(o)? 0.1:0.9;
                        });

                for (var dd=0;dd<undirectNodes1.length;dd++){
                    node.transition()
                        .delay(4100+dd*2000)
                        .duration(3000)
                        .style("opacity",function(o){
                            return undirectNodes1.slice(0,dd+1).some(elem =>elem.includes(o))|cdoNeighborPartial1.includes(o)|directNodes2.includes(o)? 0.1:0.9;
                        });
                }


                for (var dd=0;dd<undirectNodes2.length;dd++){
                    node.transition()
                        .delay(4100+dd*2000)
                        .duration(3000)
                        .style("opacity",function(o){
                            return undirectNodes2.slice(0,dd+1).some(elem =>elem==o)|undirectNodes1.some(elem =>elem.includes(o))|cdoNeighborPartial1.includes(o)|directNodes2.includes(o)? 0.1:0.9;
                        }); 
                }


                    node.transition()
                        .delay(8100)
                        .duration(3000)
                        .style("opacity",function(o){
                            return undirectNodes2.some(elem =>elem==o)|undirectNodes1.some(elem =>elem.includes(o))|cdoNeighborPartial1.includes(o)|directNodes2.includes(o)|undirectNodes3.includes(o)? 0.1:0.9;
                        });


		            link.transition()
                        .delay(100)
                        .duration(3000)
                        .style("opacity",function(o){
						      return cdoNeighborPartial1.includes(dataset.nodes[o.source.index])|cdoNeighborPartial1.includes(dataset.nodes[o.target.index])?0.1:1;
							});	

                     link.transition()
                        .delay(2100)
                        .duration(3000)
                        .style("opacity",function(o){
                              return cdoNeighborPartial1.includes(dataset.nodes[o.source.index])|cdoNeighborPartial1.includes(dataset.nodes[o.target.index])|directNodes2.includes(dataset.nodes[o.source.index])|directNodes2.includes(dataset.nodes[o.target.index])?0.1:1;
                            }); 

                for (var dd=0; dd<undirectNodes1.length; dd++){
                    link.transition()
                        .delay(4100+dd*2000)
                        .duration(3000)
                        .style("opacity",function(o){
                            return cdoNeighborPartial1.includes(dataset.nodes[o.source.index])|cdoNeighborPartial1.includes(dataset.nodes[o.target.index])|undirectNodes1.slice(0,dd+1).some(elem =>elem.includes(dataset.nodes[o.source.index]))|undirectNodes1.slice(0,dd+1).some(elem =>elem.includes(dataset.nodes[o.target.index]))|directNodes2.includes(dataset.nodes[o.source.index])|directNodes2.includes(dataset.nodes[o.target.index])? 0.1:1;
                        });
                }

                for (var dd=0;dd<undirectNodes2.length;dd++){
                    link.transition()
                        .delay(6100+dd*2000)
                        .duration(3000)
                        .style("opacity",function(o){
                            return cdoNeighborPartial1.includes(dataset.nodes[o.source.index])|cdoNeighborPartial1.includes(dataset.nodes[o.target.index])|undirectNodes1.some(elem =>elem.includes(dataset.nodes[o.source.index]))|undirectNodes1.some(elem =>elem.includes(dataset.nodes[o.target.index]))|undirectNodes2.slice(0,dd+1).some(elem =>elem==dataset.nodes[o.source.index])|undirectNodes2.slice(0,dd+1).some(elem =>elem==dataset.nodes[o.target.index])|directNodes2.includes(dataset.nodes[o.source.index])|directNodes2.includes(dataset.nodes[o.target.index])? 0.1:1;
                        }); 
                }


                    link.transition()
                        .delay(8100)
                        .duration(3000)
                        .style("opacity",function(o){
                            return cdoNeighborPartial1.includes(dataset.nodes[o.source.index])|cdoNeighborPartial1.includes(dataset.nodes[o.target.index])|undirectNodes1.some(elem =>elem.includes(dataset.nodes[o.source.index]))|undirectNodes1.some(elem =>elem.includes(dataset.nodes[o.target.index]))|undirectNodes2.some(elem =>elem==dataset.nodes[o.source.index])|undirectNodes2.some(elem =>elem==dataset.nodes[o.target.index])|directNodes2.includes(dataset.nodes[o.source.index])|directNodes2.includes(dataset.nodes[o.target.index])|undirectNodes3.includes(dataset.nodes[o.source.index])|undirectNodes3.includes(dataset.nodes[o.target.index])? 0.1:1;
                        });
            }
    }
}
// This function looks up whether a pair are neighbors
function neighboring(a,b){
        return linkedByIndex[a.index+","+b.index];  // Use console.log to check the structure and name
     }

function isConnected(a,b){
       return linkedByIndex[a.index+","+b.index]||linkedByIndex[b.index+","+a.index]||a.index==b.index;
     } 

// Set threshold to CDOs

function threshold(thresh){
     document.getElementById("range").innerHTML=thresh+" %";
	 return thresh;
}
			  
function reset(){
    d3.select("svg").remove();
	var width=window.innerWidth,
    	height=window.innerHeight;
	var toggle=0; 
    var adding=0;
 	force=d3.layout.force()
            .nodes(dataset.nodes)
            .links(dataset.link)
            .start();

	svg=d3.select("div#container")
          .append("svg")
          .attr("width",width)
          .attr("height",height)
          .attr('viewBox','0 0 '+width*1.2+' '+height*1.2)
          .attr('perserveAspectRatio','xMidYMid meet')
          .append("g");

 	link=svg.selectAll(".link")
            .data(dataset.link)
            .enter()
            .append("line")
            .attr("class","link");

 	node=svg.selectAll(".node")
             .data(dataset.nodes)
			 .enter()
			 .append("g")
			 .attr("class","node")
			 .call(force.drag);
			 
	node .append("circle")
	     .attr("r", function(d){
	                 return d.size*13;
	                 })
         .style("fill", function (d) {
	                 return d.group==1?"rgba(63, 127, 191, 0.9)":"rgba(255, 229, 0, 0.9)";
                    });
	node.append("text")
	    .attr("dx",-15)
		.text(function(d){
		     return d.name;
			 });
	node.on('click',neighboringNodes);
	
	tip=d3.select("text")
          .append("div")
          .attr("class","tooltip");
		   
// Add a legend
	colordata=[{value:1,name:"Bank"},{value:2,name:"CDO"}];
	legend = svg.selectAll('.legend')
                .data(colordata)
                .enter().append('g')
                .attr('class', 'legend')
                .attr('ID', function(d) { return d.name })
                .attr("transform", function(d,i) {
                        return "translate(" + 60 + "," + (i+3)*30 + ")";
                });

	legend.append("rect")
		.attr('width', 25).attr('height', 20)
		.attr('x', 30).attr('y', 5)
		.style('fill', function(d) {
			return d.value==1?"rgba(63, 127, 191, 0.9)":"rgba(255, 229, 0, 0.9)";
			});

	legend.append("text")
		.attr('x', 70).attr('y', 19)
		.text(function(d) { return d.name; })
		.attr("stroke","black");

	force.on("tick",function(){
	link.attr("x1",function(d){
          return d.source.x;
        })
		.attr("y1",function(d){
          return d.source.y;
        })
        .attr("x2",function (d){
          return d.target.x;
        })
        .attr("y2",function(d){
          return d.target.y;
        });
	node.attr("transform",function(d){
		return "translate("+d.x+","+d.y+")";});
		});

 linkedByIndex={}; // this is an array to store nodes and its directly connected neighbors
	for (i=0;i<dataset.nodes.length;i++){
        linkedByIndex[i+","+i]=1;
	};

	dataset.link.forEach(function (d) {
		linkedByIndex[d.source.index + "," + d.target.index] = 1;
	});

	cdo=document.getElementById('cdo');

	cdoLink=document.getElementById("cdoOwnership");
	bank=document.getElementById("bank");


	bank1=document.getElementById("bankList1");
	bank2=document.getElementById("bankList2");
    redraw=document.getElementById("redraw");

    
    if (bank1.length==bank2.length){
    	for (var i=0;i<bank1.length;i++){
			bank1.options[i].disabled=false;
			bank2.options[i].disabled=false;
		}
	}else{
		for (var i=0;i<bank1.length;i++){
			bank1.options[i].disabled=false;
		}

		for (var i=0;i<bank1.length;i++){
			bank1.options[i].disabled=false;
		}
	}
	

	// go back to default
    $('select').each(function() { this.selectedIndex = 0});
    $('input').each(function() { this.value = 0, threshold(this.value)});
    document.getElementById('redraw').value="CDOs are connected";
    document.getElementById('path').value="";
    document.getElementById('reset').value="Default";
    document.getElementById("redraw").value="CDOs are connected";
    document.getElementById("Part1").innerHTML="Part 1";
    document.getElementById("question1").style.display="block";
    document.getElementById("question2").innerHTML=original;
    document.getElementById("question3").style.display="block";
    document.getElementById("bank_cdo").style.display="block";
    document.getElementById("paragraph2").style.display="block";
}


/*
function shortestPath(){
    var starting=dataset.nodes[parseInt(bank1.value,10)];
    var ending=dataset.nodes[parseInt(bank2.value,10)];
    var directNeighbors=[];
    var containEnding=1;

    // Find direct neighbors
    node.each(function(d){
        if(isConnected(d,starting)&&d!=starting&&d.size>1){
            directNeighbors.push(d);
        }
    });

    
    // Initialize all the arrays which will be used to store all the possible pathways

    var nodePath=[];
    for(var i=0; i<directNeighbors.length; i++){
        nodePath[i]= new Array();
        nodePath[i].push(directNeighbors[i]);
    }
    

    // Start to search for the ending point
    while(containEnding==1){
        for(var i=0; i<nodePath.length; i++){
            var storing=[];
            if (nodePath[i][(nodePath[i].length-1)].size>1){
                    node.each(function(d){
                        if (isConnected(nodePath[i][(nodePath[i].length-1)],d)&&(!nodePath[i].includes(d))&&d!=starting){
                            storing.push(d);
                        }
                    });
                    nodePath[i].push(storing[0]);
                }
        }
         
        var temp=[];
        for (var j=0; j<nodePath.length; j++){
            if (nodePath[j].includes(ending)){
                temp.push(0)
            }
        }

        if (temp.includes(0)){
            containEnding=0;
        }
    }
    

    var nodeInPath=[];
    var comparing=nodePath[0].length;
    var pathIndex=0;


    for(var i=0; i<nodePath.length; i++){
      if (nodePath[i].includes(ending)){
        if ((nodePath[i].length-1)<comparing){
            comparing=nodePath[i].length;
            pathIndex++;
        }
      }else{
            if (nodePath[i].length<comparing){
            comparing=nodePath[i].length;
            pathIndex++;
        }
      }
    }
    

    for (i=0;i<nodePath[pathIndex].length; i++){
        nodeInPath.push(nodePath[pathIndex][i]);
    }


    if (!nodeInPath.includes(starting)){
        nodeInPath.push(starting);
    }

     if (!nodeInPath.includes(ending)){
        nodeInPath.push(ending);
    }
    


    node.style("opacity",function(o){
        return nodeInPath.includes(o)? 0.9:0.1;
    });
    link.style("stroke", function(o){
        return (nodeInPath.includes(o.source)&(nodeInPath.includes(o.target)))? "#F50F0F":"#999999";
    })
        .style("opacity", function(o){
        return (nodeInPath.includes(o.source)&(nodeInPath.includes(o.target)))? 0.9:0.1;
    });
        
    if (starting==undefined|ending==undefined){
        document.getElementById('path').value=" ";
        node.style("opacity",0.9);
        link.style("stroke","#999999")
            .style("opacity",0.9);
    }else
        {document.getElementById('path').value=(nodeInPath.length-2);}
}


function calculateDistance(){
    var nodePath=[];
    var nodePath2=[];
    var d=dataset.nodes[parseInt(bank1.value,10)];
    var dd=dataset.nodes[parseInt(bank2.value,10)];
    var continuing=1;
    var continuing2=1;
    // from d to dd
        node.each(function(o){
            if (isConnected(d,o)){
                if (o.size>1){
                    nodePath.push(o);
                }
            }
        });

        while(continuing==1){
            var addedNode=[];
            if (nodePath.length>0){
                node.each(function(o) {
                    nodePath.forEach(function(e){
                        if (isConnected(o,e)&(!nodePath.includes(o))&o.name!=d.name&o.size>1){
                            addedNode.push(o);
                        }
                    })
                });
            }
            nodePath=nodePath.concat(addedNode);
            if (nodePath.includes(dd)){
                continuing=0;
            }
        }



             var remainingNode=[];
            for (var i=0; i<nodePath.length; i++){
                var countConnection=0;
                for (var j=0; j<nodePath.length; j++){
                    if ((nodePath[i]!=nodePath[j])&isConnected(nodePath[i],nodePath[j])){
                        countConnection++;
                    }
                }
                if ((countConnection>1)){
                        remainingNode.push(nodePath[i]);
                    }
            }


            if (!remainingNode.includes(d)){
                remainingNode.push(d);
            }

            if (!remainingNode.includes(dd)){
                remainingNode.push(dd);
            }
           
        
            
            node.style("opacity",function(o){
                return remainingNode.includes(o)? 0.9:0.1;
            });
            link.style("stroke", function(o){
                        return (remainingNode.includes(o.source)&(remainingNode.includes(o.target)))? "#F50F0F":"#999999";
                    })
                .style("opacity", function(o){
                    return (remainingNode.includes(o.source)&(remainingNode.includes(o.target)))? 0.9:0.1;
                });

}
*/

            </script>
    </body>
</html>
 